from openai import OpenAI
from dotenv import load_dotenv
from aiogram import Router
from aiogram.types import Message
import os

router = Router()

load_dotenv()

OPENAI_TOKEN = os.environ["OPENAI_TOKEN"]
MODEL_GPT = os.environ["MODEL_GPT"]

client = OpenAI(api_key=f"{OPENAI_TOKEN}",
                base_url="https://api.proxyapi.ru/openai/v1")  # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä—É, –¥–ª—è –Ω–µ–≥–æ vpn –Ω–µ –Ω–∞–¥–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å


def gpt(text):
    # –Ω–∞—à –∑–Ω–∞–∫–æ–º—ã–π API –∑–∞–ø—Ä–æ—Å, —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å –º—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ª–∏—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫,
    # openai –ø–æ–∑–∞–±–æ—Ç–∏–ª–∏—Å—å –æ –Ω–∞—Å –∏ –≤—Å—Ç—Ä–æ–∏–ª–∏ –≤—Å–µ —ç—Ç–æ –≤ —Å–≤–æ—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É
    completion = client.chat.completions.create(
        model=f'{MODEL_GPT}',  # –ú–æ–¥–µ–ª—å –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–∞ —Å–≤–æ–π –≤–∫—É—Å
        messages=[
            # –¢—É—Ç –∑–∞–¥–∞—ë—Ç—Å—è –ª–∏—á–Ω–æ—Å—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ)
            {"role": "system", "content": "You are a bot assistant imitating a real person."},
            {'role': 'user', 'content': f'{text}'}  # –ó–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç—å
        ],
        temperature=0.5  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –æ—Ç 0 –¥–æ 1. –ß–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –≤–æ–¥—ã
    )

    english_text = completion.choices[0].message.content  # –¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –Ω–∞–ø–∏—Å–∞–ª

    return english_text


@router.message()  # –õ—é–±–æ–π —Ç–µ–∫—Å—Ç = –∑–∞–ø—Ä–æ—Å –∫ chatgpt
async def gpt_handler(message: Message):
    edited = await message.answer('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç‚ôªÔ∏è')  # –î–∞—ë–º –ø–æ–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
    try:
        await message.reply(gpt(message.text))  # –¢—É—Ç –∑–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è, –æ—Ç–¥–∞—ë—Ç—Å—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –≤—ã–≤–æ–¥–∏—Ç—Å—è
    except Exception as e:
        await message.reply("–ú–Ω–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Åü•∫ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ\n"
                            "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: \n"
                            "1) –¢–æ–∫–µ–Ω –±–æ–ª–µ–µ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω\n"
                            "2) –£ —Ç–æ–∫–µ–Ω–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –¥–µ–Ω—å–≥–∏\n"
                            "3) –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–µ–π—á–∞—Å —Å–µ—Ä–≤–µ—Ä –ø–ª–æ—Ö–æ —Å—Ä–∞–±–æ—Ç–∞–ª –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–∫—Å–∏")
        print(e) # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, —Ç–æ –º—ã –ª–æ–≤–∏–º –æ—à–∏–±–∫—É –∏ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
    await edited.delete()  # –£–¥–∞–ª—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
